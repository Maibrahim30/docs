name: Repo Sync

# **What it does**: Syncs `main` branch between github/docs (public) and github/docs-internal (private).
# **Why we have it**: Keeps open-source repo updated while maintaining an internal repo for sensitive work.
# **Who does it impact**: Open-source contributors and internal teams.
# For more details, see https://github.com/repo-sync/repo-sync#how-it-works

on:
  workflow_dispatch: # Allows manual triggering
  schedule:
    - cron: '20 */3 * * *' # Run every 3rd hour at 20 minutes past

permissions:
  contents: write
  pull-requests: write
  issues: write # Required for locking PR conversations

jobs:
  repo-sync:
    if: github.repository == 'github/docs-internal' || github.repository == 'github/docs'
    name: Repo Sync
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for accurate sync

      - name: Sync repo to branch
        uses: repo-sync/github-sync@v2
        with:
          source_repo: https://${{ secrets.DOCS_BOT_PAT_WORKFLOW }}@github.com/github/${{ github.repository == 'github/docs-internal' && 'docs' || 'docs-internal' }}.git
          source_branch: main
          destination_branch: repo-sync
          github_token: ${{ secrets.DOCS_BOT_PAT_WORKFLOW }}

      - name: Create and manage pull request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DOCS_BOT_PAT_WORKFLOW }}
          script: |
            const { owner, repo } = context.repo;
            const head = 'repo-sync';
            const base = 'main';

            // Close existing PRs to avoid duplicates
            const { data: existingPulls } = await github.rest.pulls.list({ owner, repo, head: `${owner}:${head}`, base });
            for (const pull of existingPulls) {
              console.log(`Closing existing PR #${pull.number}`);
              await github.rest.pulls.update({ owner, repo, pull_number: pull.number, state: 'closed' });
            }

            // Compare commits to check for changes
            const { data: comparison } = await github.rest.repos.compareCommits({ owner, repo, head, base });
            if (!comparison.files?.length) {
              console.log('No changes detected, exiting.');
              return;
            }

            // Create new PR
            const body = `
              Automated pull request to sync changes between public and private repos.
              This PR will be merged automatically to maintain consistency.
              **Do not squash** to preserve commit history.
            `;
            const { data: pull } = await github.rest.pulls.create({
              owner,
              repo,
              head,
              base,
              title: 'Repo Sync',
              body,
            });
            const pull_number = pull.number;
            console.log(`Created PR #${pull_number}: ${pull.html_url}`);

            // Lock PR to prevent comments
            await github.rest.issues.lock({ owner, repo, issue_number: pull_number, lock_reason: 'spam' });
            console.log(`Locked PR #${pull_number}`);

            // Wait for mergeability status (GitHub API can be slow to update)
            for (let i = 0; i < 5; i++) {
              const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number });
              if (pr.mergeable_state) {
                if (pr.mergeable_state === 'dirty' || !pr.mergeable) {
                  console.log(`PR #${pull_number} has conflicts, closing.`);
                  await github.rest.pulls.update({ owner, repo, pull_number, state: 'closed' });
                  throw new Error('Merge conflict detected, please resolve manually.');
                }
                break;
              }
              await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2s
            }

            // Merge PR
            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number,
              merge_method: 'merge', // Preserve commit history
            });
            console.log(`Merged PR #${pull_number}`);

      - name: Notify on failure
        if: ${{ failure() && github.event_name != 'workflow_dispatch' }}
        uses: ./.github/actions/slack-alert
        with:
          slack_channel_id: ${{ secrets.DOCS_ALERTS_SLACK_CHANNEL_ID }}
          slack_token: ${{ secrets.SLACK_DOCS_BOT_TOKEN }}
